######
# Metabase Report server Elastic Beanstalk configuration
# Modify the environmental variables below to customize your installation
# Comment out a variable to disable a feature
#####

packages:
  yum:
    perl-DateTime: []
    perl-Sys-Syslog: []
    perl-LWP-Protocol-https: []
    perl-Switch: []
    perl-URI: []
    perl-Digest-SHA: []
sources: 
  /opt/cloudwatch: https://aws-cloudwatch.s3.amazonaws.com/downloads/CloudWatchMonitoringScripts-1.2.1.zip
files:
  "/tmp/install" :
    mode: "000755"
    owner: root
    group: root
    source: https://inspector-agent.amazonaws.com/linux/latest/install

container_commands:
    #customize_env:
        #env:
            #NGINX_FORCE_SSL: 1
            #PAPERTRAIL_HOSTNAME: $HOSTNAME
            #PAPERTRAIL_HOST: foobar.papertrailapp.com
            #PAPERTRAIL_PORT: 12345
            #PAPERTRAIL_FILES: /var/log/nginx/access.log /var/log/nginx/error.log
        #command: true
        #ignoreErrors: false

    # do server_https first to avoid overwriting other config changes
    01_server_https:
        command: ".ebextensions/metabase_config/metabase-setup.sh server_https"
        ignoreErrors: true

    02_log_x_real_ip:
        command: ".ebextensions/metabase_config/metabase-setup.sh log_x_real_ip"
        ignoreErrors: true

    03_install_papertrail:
        command: ".ebextensions/metabase_config/metabase-setup.sh install_papertrail"
        test: test $PAPERTRAIL_HOST
        ignoreErrors: true

    05_try_papertrail:
        command: "/sbin/service remote_syslog restart"
        test: test -e /etc/log_files.yml
        ignoreErrors: true

    06_try_nginx:
        command: "/sbin/service nginx restart"
        test: nginx -t
        ignoreErrors: false

    07-setupcron:
        command: |
            echo '*/5 * * * * root perl /opt/cloudwatch/aws-scripts-mon/mon-put-instance-data.pl `{"Fn::GetOptionSetting" : { "OptionName" : "CloudWatchMetrics", "DefaultValue" : "--mem-util --disk-space-util --disk-path=/" }}` >> /var/log/cwpump.log 2>&1' > /etc/cron.d/cwpump
    
    08-changeperm:
        command: chmod 644 /etc/cron.d/cwpump
    
    09-changeperm:
        command: chmod u+x /opt/cloudwatch/aws-scripts-mon/mon-put-instance-data.pl
    
    08-install_inspector:
        command: bash -x install -u false
        cwd: /tmp/
  

option_settings:
    aws:elasticbeanstalk:command:
        option_name: Timeout
        value: 600
    aws:autoscaling:launchconfiguration:
        IamInstanceProfile : "aws-elasticbeanstalk-ec2-role"
    aws:elasticbeanstalk:customoption:
        CloudWatchMetrics : "--mem-util --mem-used --mem-avail --disk-space-util --disk-space-used --disk-space-avail --disk-path=/ --auto-scaling"